<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Code Snippet Tycoon - Chapter 1</title>
    <style>
      body {
        font-family: "Courier New", Courier, monospace;
        background-color: #1e1e1e;
        color: #d4d4d4;
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
      }
      #game-container {
        width: 100%;
        max-width: 600px;
        background-color: #252526;
        border: 1px solid #333;
        padding: 15px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      }
      #narrative-console {
        background-color: #000;
        color: #0f0; /* Green text */
        padding: 10px;
        height: 100px;
        overflow-y: auto;
        border: 1px solid #333;
        margin-bottom: 15px;
        display: flex;
        flex-direction: column-reverse; /* Newest messages at bottom, visually appearing at top if not full */
      }
      .narrative-line {
        margin: 2px 0;
        font-size: 0.9em;
      }
      .narrative-line:first-child {
        /* Style for the latest message, which is first in DOM due to prepend */
        /* No specific styling needed with flex-direction: column-reverse, it will appear at bottom if console not full */
      }

      .section {
        background-color: #2d2d2d;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #3c3c3c;
      }
      .section h3 {
        margin-top: 0;
        color: #569cd6;
        border-bottom: 1px solid #3c3c3c;
        padding-bottom: 5px;
      }
      button {
        background-color: #0e639c;
        color: white;
        border: 1px solid #1e538c;
        padding: 8px 12px;
        cursor: pointer;
        font-family: inherit;
        margin: 2px;
      }
      button:hover {
        background-color: #1177bb;
      }
      button:disabled {
        background-color: #555;
        color: #aaa;
        cursor: not-allowed;
        border-color: #444;
      }
      hr {
        border: none;
        border-top: 1px solid #3c3c3c;
        margin: 10px 0;
      }
      #victory-section {
        background-color: #000;
        color: #0f0; /* Green text */
        padding: 15px;
        text-align: center;
        border: 1px solid #0f0;
      }
      #victory-section p {
        margin: 5px 0;
      }
      #next-shift-btn {
        background-color: #0f0;
        color: #000;
        font-weight: bold;
        padding: 10px 15px;
        margin-top: 10px;
      }
      /* Make sections appear side-by-side on wider screens */
      .main-content {
        display: flex;
        flex-wrap: wrap;
        gap: 15px; /* Space between Business and Upgrades panels */
      }
      .main-content > .section {
        flex: 1; /* Allow panels to grow */
        min-width: 250px; /* Minimum width before stacking */
        margin-bottom: 0; /* Remove bottom margin as gap handles it */
      }

      /* Specific styling for initial stats bar */
      .stats-bar {
        background-color: #2d2d2d;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #3c3c3c;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .stats-bar span {
        margin-right: 15px;
      }
    </style>
  </head>
  <body>
    <div id="game-container">
      <div id="narrative-console"></div>

      <div class="stats-bar">
        <span>Code Snippets: <span id="code-snippets-total">0</span></span>
        <button id="write-snippet-btn">Write Snippet</button>
      </div>

      <div class="main-content">
        <div class="section" id="business-section">
          <h3>Business</h3>
          <p>
            Available Billable Hours: $<span id="billable-hours">0.00</span>
          </p>
          <p>Un-committed Snippets: <span id="uncommitted-snippets">0</span></p>
          <p>
            <button id="lower-rate-btn">-</button>
            Billable Rate: $<span id="billable-rate">0.10</span>
            <button id="raise-rate-btn">+</button>
          </p>
          <p>
            Task Queue Saturation: <span id="task-queue-saturation">80</span>%
          </p>
        </div>

        <div class="section" id="upgrades-section">
          <h3>Upgrades</h3>
          <p>
            Current Quality Bonus: <span id="quality-bonus-display">0</span>%
          </p>
          <p>Snippets/sec (SPS): <span id="sps-display">0</span></p>
          <hr />
          <h4>Next Available Upgrade:</h4>
          <div id="next-upgrade-details">
            <p>Name: <span id="next-upgrade-name">N/A</span></p>
            <p>Effect: <span id="next-upgrade-effect-desc">N/A</span></p>
            <p>Cost: $<span id="next-upgrade-cost">N/A</span></p>
            <button id="buy-upgrade-btn" disabled>Buy Upgrade</button>
          </div>
          <div id="all-upgrades-purchased-msg" style="display: none">
            All upgrades purchased for this chapter!
          </div>
        </div>
      </div>

      <div id="victory-section" style="display: none">
        <p id="victory-text-line1"></p>
        <p id="victory-text-line2"></p>
        <button id="next-shift-btn">Next Shift</button>
      </div>
    </div>

    <script>
      const gameState = {
        codeSnippetsTotal: 0,
        uncommittedSnippets: 0,
        billableRate: 0.1,
        billableHours: 0,
        sps: 0,
        qualityBonus: 0,

        nextUpgradeIndex: 0,
        upgrades: [
          {
            id: "linter1",
            name: "AI Linter v0.1",
            cost: 5,
            effects: { qualityBonus: 10 },
            purchased: false,
            narrative:
              "> AI Linter v0.1 installed. Code quality perception increased.",
          },
          {
            id: "macro1",
            name: "Autocomplete Macro",
            cost: 9,
            effects: { sps: 0.5 },
            purchased: false,
            narrative:
              "> A tiny script writes boilerplate while you sip coffee.",
          },
          {
            id: "templates1",
            name: "Snippet Template Library",
            cost: 15,
            effects: { qualityBonus: 15 },
            purchased: false,
            narrative:
              "> Snippet Template Library integrated. Consistency is key!",
          },
          {
            id: "daemon1",
            name: "Background Code-Gen Daemon",
            cost: 20,
            effects: { sps: 2 },
            purchased: false,
            narrative: "> Background Code-Gen Daemon is now humming along.",
          },
          {
            id: "buildScript1",
            name: "One-Click Build Script",
            cost: 35,
            effects: { sps: 5 },
            purchased: false,
            unlocksFinishFeature: true,
            narrative:
              "> One-Click Build Script deployed. Automation is sweet!",
          },
        ],

        taskQueueSaturation: 0, // Will be calculated on init and update

        narrativeMessages: [],
        maxNarrativeMessages: 10, // Show more messages in console
        milestones: {
          first100Snippets: false,
          lowTaskQueueHintShown: false,
        },

        gameWon: false,
      };

      const BASE_DEMAND = 80;
      const ELASTICITY = 800;
      const INITIAL_RATE_REFERENCE = 0.1;
      const RATE_STEP = 0.01;
      const MIN_RATE = 0.01;
      const GAME_TICK_MS = 1000;

      // DOM Elements
      const narrativeConsole = document.getElementById("narrative-console");
      const codeSnippetsTotalEl = document.getElementById(
        "code-snippets-total"
      );
      const writeSnippetBtn = document.getElementById("write-snippet-btn");

      const billableHoursEl = document.getElementById("billable-hours");
      const uncommittedSnippetsEl = document.getElementById(
        "uncommitted-snippets"
      );
      const lowerRateBtn = document.getElementById("lower-rate-btn");
      const billableRateEl = document.getElementById("billable-rate");
      const raiseRateBtn = document.getElementById("raise-rate-btn");
      const taskQueueSaturationEl = document.getElementById(
        "task-queue-saturation"
      );

      const qualityBonusDisplayEl = document.getElementById(
        "quality-bonus-display"
      );
      const spsDisplayEl = document.getElementById("sps-display");
      const nextUpgradeDetailsEl = document.getElementById(
        "next-upgrade-details"
      );
      const nextUpgradeNameEl = document.getElementById("next-upgrade-name");
      const nextUpgradeEffectDescEl = document.getElementById(
        "next-upgrade-effect-desc"
      );
      const nextUpgradeCostEl = document.getElementById("next-upgrade-cost");
      const buyUpgradeBtn = document.getElementById("buy-upgrade-btn");
      const allUpgradesPurchasedMsgEl = document.getElementById(
        "all-upgrades-purchased-msg"
      );

      const victorySectionEl = document.getElementById("victory-section");
      const victoryTextLine1El = document.getElementById("victory-text-line1");
      const victoryTextLine2El = document.getElementById("victory-text-line2");
      const nextShiftBtn = document.getElementById("next-shift-btn");

      function clamp(value, min, max) {
        return Math.max(min, Math.min(value, max));
      }

      function formatCurrency(value) {
        return value.toFixed(2);
      }

      function addNarrative(message, isGameEvent = true) {
        const prefix = isGameEvent ? "> " : "";
        const fullMessage = prefix + message;
        gameState.narrativeMessages.unshift(fullMessage); // Add to beginning
        if (
          gameState.narrativeMessages.length > gameState.maxNarrativeMessages
        ) {
          gameState.narrativeMessages.pop(); // Remove oldest
        }
        renderNarrativeConsole();
      }

      function renderNarrativeConsole() {
        narrativeConsole.innerHTML = "";
        // Iterate in reverse to show newest (gameState.narrativeMessages[0]) at the bottom of the visible list
        for (let i = gameState.narrativeMessages.length - 1; i >= 0; i--) {
          const p = document.createElement("p");
          p.className = "narrative-line";
          p.textContent = gameState.narrativeMessages[i];
          narrativeConsole.appendChild(p);
        }
        // Scroll to bottom (where newest messages are due to flex-direction: column-reverse and appendChild)
        narrativeConsole.scrollTop = narrativeConsole.scrollHeight;
      }

      function updateTaskQueueSaturation() {
        const rateDifference = gameState.billableRate - INITIAL_RATE_REFERENCE;
        gameState.taskQueueSaturation = clamp(
          BASE_DEMAND - rateDifference * ELASTICITY + gameState.qualityBonus,
          0,
          100
        );
      }

      function writeSnippet() {
        if (gameState.gameWon) return;
        gameState.uncommittedSnippets++;
        gameState.codeSnippetsTotal++;

        if (
          !gameState.milestones.first100Snippets &&
          gameState.codeSnippetsTotal >= 100
        ) {
          addNarrative("The AI autocompletes your “for” loop. Nice!");
          gameState.milestones.first100Snippets = true;
        }
        updateUI();
      }

      function changeRate(amount) {
        if (gameState.gameWon) return;
        const newRate = parseFloat(
          (gameState.billableRate + amount).toFixed(2)
        );
        if (newRate >= MIN_RATE) {
          gameState.billableRate = newRate;
          updateTaskQueueSaturation();
          updateUI();
        }
      }

      function getUpgradeEffectDescription(upgrade) {
        const effects = [];
        if (upgrade.effects.qualityBonus) {
          effects.push(`+${upgrade.effects.qualityBonus}% Quality Bonus`);
        }
        if (upgrade.effects.sps) {
          effects.push(`+${upgrade.effects.sps} SPS`);
        }
        if (upgrade.unlocksFinishFeature) {
          effects.push("Unlocks 'Finish Feature' capability");
        }
        return effects.join(", ");
      }

      function buyUpgrade() {
        if (gameState.gameWon) return;
        const upgradeIndex = gameState.nextUpgradeIndex;
        if (upgradeIndex >= gameState.upgrades.length) return;

        const upgrade = gameState.upgrades[upgradeIndex];
        if (gameState.billableHours >= upgrade.cost) {
          gameState.billableHours -= upgrade.cost;

          if (upgrade.effects.qualityBonus) {
            gameState.qualityBonus += upgrade.effects.qualityBonus;
          }
          if (upgrade.effects.sps) {
            gameState.sps += upgrade.effects.sps;
          }
          // No specific game mechanic for 'unlocksFinishFeature' other than narrative and victory condition check

          upgrade.purchased = true;
          addNarrative(upgrade.narrative);
          gameState.nextUpgradeIndex++;

          checkVictory(); // Check victory after buying, especially for the last upgrade
          updateUI();
        }
      }

      function checkVictory() {
        if (gameState.gameWon) return;

        const buildScriptPurchased =
          gameState.upgrades[4] && gameState.upgrades[4].purchased;
        if (buildScriptPurchased || gameState.codeSnippetsTotal >= 1000) {
          gameState.gameWon = true;
          addNarrative("Milestone reached: Basic automation in place.");
          addNarrative(
            "Chapter 1 complete! Click “Next Shift” to continue →",
            false
          ); // Second line without '>'

          victoryTextLine1El.textContent =
            "> Milestone reached: Basic automation in place.";
          victoryTextLine2El.textContent =
            "> Chapter 1 complete! Click “Next Shift” to continue →";
          victorySectionEl.style.display = "block";

          // Disable game interactions
          writeSnippetBtn.disabled = true;
          lowerRateBtn.disabled = true;
          raiseRateBtn.disabled = true;
          buyUpgradeBtn.disabled = true;
        }
      }

      function updateUI() {
        codeSnippetsTotalEl.textContent = Math.floor(
          gameState.codeSnippetsTotal
        );
        billableHoursEl.textContent = formatCurrency(gameState.billableHours);
        uncommittedSnippetsEl.textContent = Math.floor(
          gameState.uncommittedSnippets
        );
        billableRateEl.textContent = formatCurrency(gameState.billableRate);
        taskQueueSaturationEl.textContent = Math.floor(
          gameState.taskQueueSaturation
        );

        qualityBonusDisplayEl.textContent = gameState.qualityBonus;
        spsDisplayEl.textContent = gameState.sps.toFixed(1);

        lowerRateBtn.disabled =
          gameState.gameWon || gameState.billableRate <= MIN_RATE;
        raiseRateBtn.disabled = gameState.gameWon; // No specific upper limit, demand handles it
        writeSnippetBtn.disabled = gameState.gameWon;

        if (gameState.nextUpgradeIndex < gameState.upgrades.length) {
          const nextUpgrade = gameState.upgrades[gameState.nextUpgradeIndex];
          nextUpgradeNameEl.textContent = nextUpgrade.name;
          nextUpgradeEffectDescEl.textContent =
            getUpgradeEffectDescription(nextUpgrade);
          nextUpgradeCostEl.textContent = formatCurrency(nextUpgrade.cost);
          buyUpgradeBtn.disabled =
            gameState.gameWon || gameState.billableHours < nextUpgrade.cost;
          nextUpgradeDetailsEl.style.display = "block";
          allUpgradesPurchasedMsgEl.style.display = "none";
        } else {
          nextUpgradeDetailsEl.style.display = "none";
          allUpgradesPurchasedMsgEl.style.display = "block";
          buyUpgradeBtn.disabled = true;
        }
      }

      function gameLoop() {
        if (gameState.gameWon) return;

        // Passive Snippet Generation
        const snippetsFromSps = gameState.sps * (GAME_TICK_MS / 1000);
        gameState.uncommittedSnippets += snippetsFromSps;
        gameState.codeSnippetsTotal += snippetsFromSps;

        // Autopush (selling)
        const snippetsToCommit = Math.min(
          Math.floor(gameState.uncommittedSnippets), // Only commit whole snippets
          Math.floor(gameState.taskQueueSaturation / 10)
        );

        if (snippetsToCommit > 0) {
          const earnings = snippetsToCommit * gameState.billableRate;
          gameState.billableHours += earnings;
          gameState.uncommittedSnippets -= snippetsToCommit;
        }

        // Update demand (it might change due to quality bonus from upgrades, even if rate doesn't change)
        updateTaskQueueSaturation();

        // Narrative Triggers
        if (
          gameState.taskQueueSaturation < 15 &&
          !gameState.milestones.lowTaskQueueHintShown
        ) {
          addNarrative("Managers overwhelmed; maybe lower your rate?");
          gameState.milestones.lowTaskQueueHintShown = true;
        } else if (
          gameState.taskQueueSaturation >= 15 &&
          gameState.milestones.lowTaskQueueHintShown
        ) {
          // Optional: Reset hint if condition no longer met, so it can appear again
          // gameState.milestones.lowTaskQueueHintShown = false;
        }

        // Check for 100 snippets milestone (if not hit by manual click)
        if (
          !gameState.milestones.first100Snippets &&
          gameState.codeSnippetsTotal >= 100
        ) {
          addNarrative("The AI autocompletes your “for” loop. Nice!");
          gameState.milestones.first100Snippets = true;
        }

        checkVictory();
        updateUI();
      }

      // Event Listeners
      writeSnippetBtn.addEventListener("click", writeSnippet);
      lowerRateBtn.addEventListener("click", () => changeRate(-RATE_STEP));
      raiseRateBtn.addEventListener("click", () => changeRate(RATE_STEP));
      buyUpgradeBtn.addEventListener("click", buyUpgrade);
      nextShiftBtn.addEventListener("click", () => {
        // For Chapter 1, this button doesn't load a new chapter but could reset or show a message.
        // As per prompt, it just exists.
        alert("Chapter 2 is under development! Thanks for playing Chapter 1.");
      });

      // Initialize Game
      function init() {
        addNarrative("You install a free AI assistant extension…");
        updateTaskQueueSaturation(); // Initial calculation
        updateUI();
        setInterval(gameLoop, GAME_TICK_MS);
      }

      window.onload = init;
    </script>
  </body>
</html>
